<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Barbiere â€¢ Prenotazioni</title>
  <link rel="stylesheet" href="./css/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <meta name="theme-color" content="#0a0e14">
</head>
<body>
  <div class="nav">
    <a class="brand" href="./barber-login.html" title="Home">
      <div class="mark"><img src="./img/Logo.png" alt="BeshBarber"></div>
      <div class="title">
        <div>BeshBarber</div>
        <small>Sempre Fresco!</small>
      </div>
    </a>
    <div class="actions">
      <a class="btn small" href="./barber-profile.html">Profilo</a>
      <a class="btn small" href="./index.html">App Cliente</a>
      <button id="btnLogout" class="btn small">Logout</button>
    </div>
  </div>

  <div class="container">

    <div class="grid">
      <div class="card">
        <div class="hd">
          <h1 class="h1">DisponibilitÃ </h1>
          <p class="p">Aggiungi fasce orarie per la data selezionata (slot 30m).</p>
        </div>
        <div class="bd">
          <div class="row">
            <div class="field">
              <label>Data</label>
              <input id="day" type="date" />
            </div>
            <div class="field">
              <label>Inizio</label>
              <input id="start" type="time" value="09:00" />
            </div>
            <div class="field">
              <label>Fine</label>
              <input id="end" type="time" value="13:00" />
            </div>
            <div class="field" style="flex:0 0 160px">
              <label>&nbsp;</label>
              <button id="btnAddAv" class="btn primary">Aggiungi</button>
            </div>
          </div>

          <div class="sep"></div>
          <div id="avList" class="list"></div>

          <div id="toast" class="toast"></div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <h1 class="h1">Prenotazioni in attesa</h1>
          <p class="p">Accetta o rifiuta le richieste (pending) - Ordinate dalla piÃ¹ recente.</p>
        </div>
        <div class="bd">
          <div id="pending" class="list scrollable"></div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <h1 class="h1">Prenotazioni Accettate</h1>
          <p class="p">Completa o segna come no-show.</p>
        </div>
        <div class="bd">
          <div id="accepted" class="list scrollable"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Reject -->
  <div id="rejectModal" class="modal" style="display:none;";
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="h2">Motivo del rifiuto</h2>
        <button id="closeRejectModal" class="modal-close" style="background:none; border:none; color:var(--text); cursor:pointer; font-size:24px; padding:0;">âœ•</button>
      </div>
      <div class="modal-body">
        <label>Spiega al cliente perchÃ© rifiuti la prenotazione:</label>
        <textarea id="rejectionReason" placeholder="Es. Barbiere giÃ  pieno per quel giorno, time slot non piÃ¹ disponibile, etc..." style="width:100%; height:100px; padding:10px; border:1px solid var(--line); border-radius:8px; background:rgba(10,14,20,.5); color:var(--text); font-family:var(--font); resize:vertical; margin-top:10px;"></textarea>
      </div>
      <div class="modal-footer" style="display:flex; gap:10px; justify-content:flex-end; margin-top:16px;">
        <button id="cancelRejectModal" class="btn small" style="background:rgba(255,255,255,.1);">Annulla</button>
        <button id="confirmReject" class="btn small danger">Rifiuta</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from "./js/supabaseClient.js";
    import { signOut, requireAuthOrRedirect, getMyRole } from "./js/auth.js";
    import { addAvailability, listPendingBookings, setBookingStatus, completeBooking } from "./js/barber.js";

    const $ = (id) => document.getElementById(id);
    const toast = (m) => { $("toast").textContent = m; $("toast").classList.add("show"); };

    await requireAuthOrRedirect("./barber-login.html");
    
    let role;
    try {
      role = await getMyRole();
    } catch (e) {
      console.error("Error getting role:", e);
      window.location.href = "./barber-login.html";
    }
    
    if (role !== "barber") {
      window.location.href = "./index.html";
    }

    const today = new Date();
    $("day").value = today.toISOString().slice(0,10);

 function translateStatus(status) {
  const translations = {
    pending: "in attesa",
    accepted: "accettata",
    rejected: "rifiutata",
    completed: "completata"
  };
  return translations[status] || status;
}


    async function loadAvailability() {
      const { data: { user } } = await supabase.auth.getUser();

      const { data, error } = await supabase
        .from("availability")
        .select("id, day, start_time, end_time, is_active")
        .eq("barber_id", user.id)
        .eq("day", $("day").value)
        .order("start_time", { ascending: true });

      if (error) throw error;

    $("avList").innerHTML =
  (data.length ? "" : `<div class="p">Nessuna fascia inserita per questa data.</div>`) +
  data.map(a => {
    const st = a.start_time.slice(0,5);
    const en = a.end_time.slice(0,5);
    return `
      <div class="item">
        <div class="top">
          <div><b>${a.day}</b> â€¢ ${st}-${en}</div>
          <span class="pill ${a.is_active ? "accepted" : "cancelled"}">
            ${a.is_active ? "active" : "off"}
          </span>
        </div>
        <div class="meta">Slot: 30 minuti</div>

        <div class="row" style="margin-top:10px">
          <button class="btn small danger" data-del-av="${a.id}">ðŸ—‘ Rimuovi</button>
        </div>
      </div>
    `;
  }).join("");

    }

    // âœ… Delete fascia disponibilitÃ 
$("avList").querySelectorAll("[data-del-av]").forEach(btn => {
  btn.onclick = async () => {
    if (!confirm("Vuoi rimuovere questa fascia?")) return;

    try {
      btn.disabled = true;

      const { error: delErr } = await supabase
        .from("availability")
        .delete()
        .eq("id", btn.dataset.delAv);

      if (delErr) throw delErr;

      toast("âœ“ Fascia rimossa.");
      await loadAvailability();
    } catch (e) {
      toast("âœ— " + e.message);
    } finally {
      btn.disabled = false;
    }
  };
});


    async function loadPending() {
      const rows = await listPendingBookings();

      // Aggiungi JOIN per ottenere i nomi dei clienti
      const rowsWithNames = await Promise.all(rows.map(async (b) => {
        const { data: customer, error } = await supabase
          .from("profiles")
          .select("full_name")
          .eq("id", b.customer_id)
          .single();
        
        return {
          ...b,
          customer_name: customer?.full_name || "Cliente"
        };
      }));

      $("pending").innerHTML = (rowsWithNames.length ? "" : `<div class="p">Nessuna richiesta pending.</div>`) + rowsWithNames.map(b => {
        const st = b.start_time.slice(0,5);
        const en = b.end_time.slice(0,5);
        const translatedStatus = translateStatus(b.status);
        return `
          <div class="item">
            <div class="top">
              <div>
                <b>${b.customer_name}</b>
                <div class="meta" style="margin-top:2px;">${b.day} â€¢ ${st}-${en}</div>
              </div>
              <span class="pill pending">${translatedStatus}</span>
            </div>
            <div class="meta">${b.note ? "Nota: " + b.note : "â€”"}</div>
            <div class="row" style="margin-top:10px">
              <button class="btn small ok" data-act="accept" data-id="${b.id}">Accetta</button>
              <button class="btn small danger" data-act="reject" data-id="${b.id}">Rifiuta</button>
            </div>
          </div>
        `;
      }).join("");

      $("pending").querySelectorAll("button[data-act]").forEach(btn => {
        btn.onclick = async () => {
          try {
            btn.disabled = true;
            const action = btn.dataset.act;
            const bookingId = btn.dataset.id;
            
            if (action === "accept") {
              await setBookingStatus(bookingId, "accepted");
              await loadPending();
            } else if (action === "reject") {
              // Apri il modal per il motivo del reject
              $("rejectModal").bookingId = bookingId;
              $("rejectModal").style.display = "flex";
              $("rejectionReason").focus();
            }
          } catch (e) { toast(e.message); }
          finally { btn.disabled = false; }
        };
      });
    }

    // Gestione Modal Reject
    $("closeRejectModal").onclick = () => {
      $("rejectModal").style.display = "none";
      $("rejectionReason").value = "";
    };

    $("cancelRejectModal").onclick = () => {
      $("rejectModal").style.display = "none";
      $("rejectionReason").value = "";
    };

    $("confirmReject").onclick = async () => {
      const reason = $("rejectionReason").value.trim();
      if (!reason) {
        toast("âœ— Inserisci un motivo per il rifiuto.");
        return;
      }

      try {
        $("confirmReject").disabled = true;
        const bookingId = $("rejectModal").bookingId;
        await setBookingStatus(bookingId, "rejected", reason);
        toast("âœ“ Prenotazione rifiutata.");
        $("rejectModal").style.display = "none";
        $("rejectionReason").value = "";
        await loadPending();
      } catch (e) { 
        toast("âœ— " + e.message); 
      } finally {
        $("confirmReject").disabled = false;
      }
    };

    async function loadAccepted() {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error("Not logged in");

        const { data, error } = await supabase
          .from("bookings")
          .select("id, day, start_time, customer_id, status, note")
          .eq("barber_id", user.id)
          .eq("status", "accepted")
          .order("day", { ascending: true })
          .order("start_time", { ascending: true });

        if (error) throw error;

        // Aggiungi JOIN per ottenere i nomi dei clienti
        const dataWithNames = await Promise.all(data.map(async (b) => {
          const { data: customer, error } = await supabase
            .from("profiles")
            .select("full_name")
            .eq("id", b.customer_id)
            .single();
          
          return {
            ...b,
            customer_name: customer?.full_name || "Cliente"
          };
        }));

        $("accepted").innerHTML = (dataWithNames.length ? "" : `<div class="p">Nessuna prenotazione accettata.</div>`) + dataWithNames.map(b => {
          const st = b.start_time.slice(0,5);
          const en = new Date(new Date(`2000-01-01T${b.start_time}`).getTime() + 30*60000).toTimeString().slice(0,5);
          return `
            <div class="item">
              <div class="top">
                <div>
                  <b>${b.customer_name}</b>
                  <div class="meta" style="margin-top:2px;">${b.day} â€¢ ${st}-${en}</div>
                </div>
                <span class="pill ok" style="background:rgba(38,213,102,.15); border-color:rgba(38,213,102,.3); color:var(--ok);">accettata</span>
              </div>
              <div class="meta">${b.note ? "Nota: " + b.note : "â€”"}</div>
              <div class="row" style="margin-top:10px">
                <button class="btn small ok" data-complete="${b.id}">âœ“ Completato</button>
                <button class="btn small danger" data-noshow="${b.id}">âœ— No-show</button>
              </div>
            </div>
          `;
        }).join("");

        // Aggiungi click handlers
        $("accepted").querySelectorAll("[data-complete]").forEach(btn => {
          btn.onclick = async () => {
            try {
              btn.disabled = true;
              await completeBooking(btn.dataset.complete, false);
              toast("âœ“ Taglio completato! XP +10");
              await loadAccepted();
              await loadPending();
            } catch (e) { toast("âœ— " + e.message); }
            finally { btn.disabled = false; }
          };
        });

        $("accepted").querySelectorAll("[data-noshow]").forEach(btn => {
          btn.onclick = async () => {
            if (!confirm("Sei sicuro? Il cliente non riceverÃ  XP.")) return;
            try {
              btn.disabled = true;
              await completeBooking(btn.dataset.noshow, true);
              toast("âœ“ Segnato come no-show.");
              await loadAccepted();
              await loadPending();
            } catch (e) { toast("âœ— " + e.message); }
            finally { btn.disabled = false; }
          };
        });
      } catch (e) {
        console.error("Error loading accepted bookings:", e);
        toast("âœ— Errore: " + e.message);
      }
    }

    $("btnAddAv").onclick = async () => {
      try {
        $("toast").classList.remove("show");
        $("btnAddAv").disabled = true;
        
        // Validazione inputs
        const day = $("day").value;
        const start = $("start").value;
        const end = $("end").value;
        
        if (!day || !start || !end) {
          throw new Error("Compila tutti i campi: data, inizio e fine.");
        }
        
        await addAvailability(day, start, end);
        toast("âœ“ DisponibilitÃ  aggiunta con successo.");
        
        // Reset form
        $("start").value = "09:00";
        $("end").value = "13:00";
        
        await loadAvailability();
      } catch (e) { 
        toast("âœ— " + e.message);
      } finally {
        $("btnAddAv").disabled = false;
      }
    };

    $("day").onchange = async () => {
      await loadAvailability();
      await loadPending();
    };

    $("btnLogout").onclick = async () => {
      await signOut();
      window.location.href = "./barber-login.html";
    };

    // init
    await loadAvailability();
    await loadPending();
    await loadAccepted();
  </script>

  <footer>
    <p>Â© 2025 BeshBarber â€¢ Premium Booking System</p>
    <p>by <strong>JBÂ®</strong></p>
  </footer>
</body>
</html>
