<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profilo Barbiere • BeshBarber</title>
  <link rel="stylesheet" href="./css/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <meta name="theme-color" content="#0a0e14">
</head>
<body>
  <div class="nav">
    <a class="brand" href="./barber.html" title="Home">
      <div class="mark"><img src="./img/Logo.png" alt="BeshBarber"></div>
      <div class="title">
        <div>BeshBarber</div>
        <small>Sempre Fresco!</small>
      </div>
    </a>
    <div class="actions">
      <a class="btn small" href="./barber.html">Dashboard</a>
      <button id="btnLogout" class="btn small">Logout</button>
    </div>
  </div>

  <div class="container">
    <div class="grid">
      <!-- Card Profilo -->
      <div class="card">
        <div class="hd">
          <h1 class="h1">Profilo Barbiere</h1>
          <p class="p">Le tue statistiche e il tuo livello.</p>
        </div>
        <div class="bd">
          <div style="display: flex; gap: 32px; align-items: center;">
            <!-- Stats sinistra -->
            <div style="flex: 1;">
              <div style="margin-bottom: 24px;">
                <p style="color: var(--muted); font-size: 12px; margin: 0 0 4px 0;">NOME</p>
                <p style="font-size: 24px; font-weight: 700; margin: 0;" id="barberName">—</p>
              </div>
              
              <div style="margin-bottom: 24px;">
                <p style="color: var(--muted); font-size: 12px; margin: 0 0 4px 0;">EMAIL</p>
                <p style="font-size: 14px; margin: 0;" id="barberEmail">—</p>
              </div>
            </div>

            <!-- Stats destra -->
            <div style="flex: 1; border-left: 1px solid var(--line); padding-left: 32px;">
              <div style="margin-bottom: 24px;">
                <p style="color: var(--accent); font-size: 12px; margin: 0 0 4px 0; font-weight: 600;">TAGLI COMPLETATI</p>
                <p style="font-size: 32px; font-weight: 800; color: var(--accent); margin: 0;" id="totalCuts">0</p>
              </div>
              
              <div>
                <p style="color: var(--muted); font-size: 12px; margin: 0 0 4px 0;">LIVELLO</p>
                <div style="display: flex; gap: 12px; align-items: center;">
                  <p style="font-size: 28px; font-weight: 800; color: var(--ok); margin: 0;" id="barberLevel">1</p>
                  <span style="font-size: 12px; color: var(--muted);">|</span>
                  <p style="font-size: 12px; color: var(--muted); margin: 0;" id="xpText">0 / 100 XP</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Progress Bar XP -->
          <div style="margin-top: 32px;">
            <p style="color: var(--muted); font-size: 12px; margin: 0 0 8px 0;">ESPERIENZA</p>
            <div style="width: 100%; height: 12px; background: rgba(255,255,255,.05); border-radius: 999px; overflow: hidden; border: 1px solid var(--line);">
              <div id="xpBar" style="height: 100%; background: linear-gradient(90deg, var(--ok), var(--accent)); width: 0%; transition: width 0.3s ease;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tagli Recenti -->
      <div class="card">
        <div class="hd">
          <h1 class="h1">Tagli Recenti</h1>
          <p class="p">Ultimi 10 clienti serviti.</p>
        </div>
        <div class="bd">
          <div id="recentCuts" class="list scrollable"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <footer>
    <p>© 2025 BeshBarber • Premium Booking System</p>
    <p>by <strong>JB®</strong></p>
  </footer>

  <script type="module">
    import { supabase } from "./js/supabaseClient.js";
    import { signOut, requireAuthOrRedirect, getMyRole } from "./js/auth.js";

    const $ = (id) => document.getElementById(id);
    const toast = (m) => { $("toast").textContent = m; $("toast").classList.add("show"); };

    await requireAuthOrRedirect("./barber-login.html");
    
    let role;
    try {
      role = await getMyRole();
    } catch (e) {
      console.error("Error getting role:", e);
      window.location.href = "./barber-login.html";
    }
    
    if (role !== "barber") {
      window.location.href = "./app.html";
    }

    async function loadProfile() {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error("Not logged in");

        // Carica profilo
        const { data: profile, error: profileErr } = await supabase
          .from("profiles")
          .select("full_name, total_cuts, current_xp, current_level")
          .eq("id", user.id)
          .single();

        if (profileErr) throw profileErr;

        $("barberName").textContent = profile?.full_name || "—";
        $("barberEmail").textContent = user.email;
        $("totalCuts").textContent = profile?.total_cuts || 0;
        $("barberLevel").textContent = profile?.current_level || 1;

        // Calcola XP per il livello
        const xpPerLevel = 100;
        const currentXP = profile?.current_xp || 0;
        const xpNeeded = xpPerLevel * (profile?.current_level || 1);
        const xpProgress = (currentXP % xpPerLevel);
        const xpPercent = (xpProgress / xpPerLevel) * 100;

        $("xpText").textContent = `${xpProgress} / ${xpPerLevel} XP`;
        $("xpBar").style.width = xpPercent + "%";

        // Carica tagli recenti
        const { data: recentCuts, error: cutsErr } = await supabase
          .from("bookings")
          .select("id, day, start_time, customer_id, status")
          .eq("barber_id", user.id)
          .eq("status", "completed")
          .order("updated_at", { ascending: false })
          .limit(10);

        if (cutsErr) throw cutsErr;

        // Aggiungi JOIN per ottenere i nomi dei clienti
        const cutsWithNames = await Promise.all((recentCuts || []).map(async (cut) => {
          const { data: customer, error } = await supabase
            .from("profiles")
            .select("full_name")
            .eq("id", cut.customer_id)
            .single();
          
          if (error) {
            console.error("Error fetching customer name for:", cut.customer_id, error);
          }
          
          return {
            ...cut,
            customer_name: customer?.full_name || "Cliente"
          };
        }));

        $("recentCuts").innerHTML = (cutsWithNames?.length ? "" : `<div class="p">Nessun taglio completato.</div>`) + (cutsWithNames || []).map(cut => {
          const st = cut.start_time.slice(0, 5);
          return `
            <div class="item">
              <div class="top">
                <div>
                  <b>${cut.customer_name || "Cliente"}</b>
                  <div class="meta" style="margin-top:2px;">${cut.day} • ${st}</div>
                </div>
                <span class="pill ok">✓ Completato</span>
              </div>
            </div>
          `;
        }).join("");

      } catch (e) {
        console.error("Error loading profile:", e);
        toast("✗ Errore nel caricamento del profilo: " + e.message);
      }
    }

    $("btnLogout").onclick = async () => {
      await signOut();
      window.location.href = "./barber-login.html";
    };

    // Init
    await loadProfile();
  </script>

  <style>
    .pill.ok {
      background: rgba(38, 211, 102, .15);
      border-color: rgba(38, 211, 102, .3);
      color: var(--ok);
    }
  </style>
</body>
</html>
